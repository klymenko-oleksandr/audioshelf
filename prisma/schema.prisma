// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Book {
  id             String             @id @default(cuid())
  title          String
  author         String
  description    String?
  coverObjectKey String?
  totalDuration  Float              @default(0) // Sum of all chapter durations in seconds
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  chapters       Chapter[]
  progress       PlaybackProgress[]
}

model Chapter {
  id        String   @id @default(cuid())
  bookId    String
  title     String   // e.g., "Chapter 1" or custom title
  order     Int      // Order within the book (1-indexed)
  objectKey String   // S3 object key for the audio file
  mimeType  String
  duration  Float    @default(0) // Duration in seconds
  createdAt DateTime @default(now())
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, order])
  @@index([bookId])
}

model PlaybackProgress {
  id               String   @id @default(cuid())
  sessionId        String
  bookId           String
  currentChapterId String?  // Which chapter user is on (null = not started)
  position         Float    @default(0) // Position within current chapter
  completed        Boolean  @default(false) // Has user finished the entire book?
  updatedAt        DateTime @updatedAt
  book             Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([sessionId, bookId])
  @@index([sessionId])
}
